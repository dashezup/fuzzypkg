#!/bin/env bash

selected="$(
  xbps-query -R --search= \
    | sed -Er "s/(\[\*\].*)/$( printf "\033[0;32m" )\1$( printf "\033[0m" )/"\
      | fzf \
        --prompt "Package name >" \
        --layout=reverse \
        --cycle \
        -n 2.. \
        --preview="xq {2}" \
        --preview-window=down:wrap \
        --ansi -e -m \
        --border=sharp \
        --marker=M \
        --no-sort
)"

[ -z "${selected}" ] && exit

while read -r line; do
  if echo "${line}" | grep -q "\[\*\]" >/dev/null 2>&1; then
    UNINSTALL+=( "$( echo "${line}" | awk '{ print $2 }' )" )
  else
    INSTALL+=( "$( echo "${line}" | awk '{ print $2 }' )" )
  fi
done <<<"${selected}"

if [ "$(id -u)" -eq 0 ]; then
  if [ -n "${UNINSTALL[*]}" ]; then
    echo "Executing xbps-remove -R " "${UNINSTALL[@]}"
    xbps-remove -R "${UNINSTALL[@]}"
  fi
  if [ -n "${INSTALL[*]}" ]; then
    echo "Executing xbps-install -Rs" "${INSTALL[@]}"
    xbps-install -Rs "${INSTALL[@]}"
  fi
fi
